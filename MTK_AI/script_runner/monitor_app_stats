#!/system/bin/sh

# --- CONFIGURATION ---
TEMP_FILE="/sys/class/power_supply/battery/temp"
VOLT_FILE="/sys/class/power_supply/battery/voltage_now"
CURR_FILE="/sys/class/power_supply/battery/current_now"
STATS_DIR="/sdcard/MTK_AI_Engine"
CONFIG_DIR="/sdcard/MTK_AI_Engine"
NOTIFY_ENABLED_FILE="$CONFIG_DIR/enable_notifications"
PROC_STAT="/proc/stat"
GAME_LIST_FILE="/sdcard/MTK_AI_Engine/game_list.txt"  # â† NEW: Multi-app list

[ ! -f "$VOLT_FILE" ] && VOLT_FILE="/sys/class/power_supply/bms/voltage_now"
[ ! -f "$CURR_FILE" ] && CURR_FILE="/sys/class/power_supply/bms/current_now"

mkdir -p "$STATS_DIR" 2>/dev/null
mkdir -p "$CONFIG_DIR" 2>/dev/null

# ==========================================
# ðŸŽ¯ LOAD MONITORED APPS FROM game_.txt
# ==========================================
# Load monitored apps from game_list.txt
load_monitored_apps() {
    if [ -f "$GAME_LIST_FILE" ]; then
        # Use grep to filter valid lines (contains dot, not comment, not empty)
        grep -v '^#' "$GAME_LIST_FILE" 2>/dev/null | \
        grep -v '^[[:space:]]*$' | \
        grep '\.' | \
        sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | \
        sed 's/\r$//'
    fi
}

# Check if a package is in our monitored list
is_monitored_app() {
    local pkg="$1"
    local apps=$(load_monitored_apps)
    
    echo "$apps" | while read app; do
        if [ "$app" = "$pkg" ]; then
            echo "1"
            return
        fi
    done
}

# ==========================================
# ðŸ“¢ NOTIFY ENGINE
# ==========================================
notify_engine() {
    [ ! -f "$NOTIFY_ENABLED_FILE" ] && return 0
    
    local title="$1"
    local msg="$2"
        RAW_TEMP=$(cat /sys/class/power_supply/battery/temp 2>/dev/null || echo "0")
    B_TEMP="$((RAW_TEMP / 10)).$((RAW_TEMP % 10))Â°C"

    VOLT_FILE="/sys/class/power_supply/battery/voltage_now"
    CURR_FILE="/sys/class/power_supply/battery/current_now"
    [ ! -f "$VOLT_FILE" ] && VOLT_FILE="/sys/class/power_supply/bms/voltage_now"
    [ ! -f "$CURR_FILE" ] && CURR_FILE="/sys/class/power_supply/bms/current_now"

    POWER_WATTS="N/A"
    if [ -f "$VOLT_FILE" ] && [ -f "$CURR_FILE" ]; then
        VOLT=$(cat "$VOLT_FILE" 2>/dev/null | tr -d '[:space:]')
        CURR=$(cat "$CURR_FILE" 2>/dev/null | tr -d '[:space:]')
        POWER_WATTS=$(awk -v v="$VOLT" -v c="$CURR" 'BEGIN {
            volts = v / 1000000; amps = c / 1000000
            if (amps < 0) amps = -amps
            val = volts * amps
            if (val >= 0.01 && val <= 60) printf "%.2fW", val; else print "N/A"
        }')
    fi
    
    local full_msg="$msg | Pwr: $POWER_WATTS | Temp: $B_TEMP"
    su -lp 2000 -c "cmd notification post -S bigtext -t '$title' tag '$full_msg'" >/dev/null 2>&1
}

# ==========================================
# ðŸ” GET CURRENT FOCUSED PACKAGE
# ==========================================
get_current_pkg() {
    local raw_output=""
    local pkg=""
    
    # Method 1: cmd window
    raw_output=$(cmd window get-focus 2>/dev/null)
    if [ -n "$raw_output" ]; then
        pkg=$(echo "$raw_output" | grep -oE '[a-zA-Z0-9._]+/[a-zA-Z0-9._]+' | head -n 1 | cut -d'/' -f1)
    fi
    
    # Method 2: dumpsys window
    if [ -z "$pkg" ]; then
        raw_output=$(dumpsys window windows 2>/dev/null | grep -E 'mCurrentFocus|mFocusedApp')
        if [ -n "$raw_output" ]; then
            pkg=$(echo "$raw_output" | grep -oE '[a-zA-Z0-9._]+/[a-zA-Z0-9._]+' | head -n 1 | cut -d'/' -f1)
        fi
    fi
    
    # Method 3: dumpsys displays
    if [ -z "$pkg" ]; then
        raw_output=$(dumpsys window displays 2>/dev/null)
        if [ -n "$raw_output" ]; then
            pkg=$(echo "$raw_output" | grep -oE '[a-zA-Z0-9._]+/[a-zA-Z0-9._]+' | head -n 1 | cut -d'/' -f1)        
            fi
    fi
    
    echo "$pkg" | tr -d '[:space:]'
}

# ==========================================
# ðŸš€ GET REAL FPS FROM LOGCAT
# ==========================================
get_real_fps() {
    local pkg="$1"
    local fps=0
    
    fps=$(logcat -b main -d 2>/dev/null | \
          grep "BufferQueueProducer.*$pkg.*fps=" | \
          tail -5 | \
          awk -F'fps=' '{
              split($2,a," ")
              fps=a[1]+0
              if(fps > 0 && fps > max) max = fps
          }
          END { if(max > 0) printf "%.0f", max; else print "0" }')
    
    [ -z "$fps" ] && fps=0
    echo "$fps"
}

# ==========================================
# ðŸ“Š CALCULATE CPU LOAD %
# ==========================================
get_cpu_load() {
    read cpu u1 n1 s1 i1 w1 x1 y1 rest < $PROC_STAT
    sleep 0.4
    read cpu u2 n2 s2 i2 w2 x2 y2 rest < $PROC_STAT
    
    local idle=$((i2 - i1))
    local total=$(( (u2+n2+s2+i2+w2+x2+y2) - (u1+n1+s1+i1+w1+x1+y1) ))
    
    if [ "$total" -eq 0 ]; then echo "0"; return; fi
    awk -v t="$total" -v id="$idle" 'BEGIN{ l=(t-id)/t*100; if(l<0)l=0; if(l>100)l=100; printf "%.0f", l }'
}

# ==========================================
# ðŸ’¾ SAVE STATS TO FILE
# ==========================================
save_stats() {
    local pkg="$1"
    local total_w="$2"
    local total_t="$3"
    local total_f="$4"    local count="$5"
    
    if [ "$count" -gt 0 ]; then
        AVG_W=$(awk -v t="$total_w" -v c="$count" 'BEGIN{printf "%.2f",t/c}')
        AVG_T=$(awk -v t="$total_t" -v c="$count" 'BEGIN{printf "%.1f",t/c}')
        AVG_F=$(awk -v t="$total_f" -v c="$count" 'BEGIN{printf "%.0f",t/c}')
        
        {
            echo "Package: $pkg"
            echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "Samples: $count"
            echo "Avg_Power: ${AVG_W}W"
            echo "Avg_Temp: ${AVG_T}Â°C"
            echo "Avg_FPS: ${AVG_F} (Real)"
        } > "$STATS_DIR/stats_${pkg}.txt"
    fi
}

# ==========================================
# ðŸš€ MAIN LOOP
# ==========================================
# ==========================================
# ðŸš€ STARTUP & VALIDATION
# ==========================================
echo "âš¡ Monitor: Multi-app mode"
echo "ðŸ“‹ Source: $GAME_LIST_FILE"
echo "ðŸ“Š FPS Source: logcat BufferQueueProducer (Real FPS)"
echo ""

# Check if game list exists
if [ ! -f "$GAME_LIST_FILE" ]; then
    echo "âŒ Error: $GAME_LIST_FILE not found"
    echo "Create it with one package per line:"
    echo "  com.mobile.legends"
    echo "  com.example.game"
    exit 1
fi

# Load apps to temp file (for repeated use)
load_monitored_apps > /tmp/mon_apps_list.txt

# Count and display
APP_COUNT=$(wc -l < /tmp/mon_apps_list.txt | tr -d ' ')
if [ "$APP_COUNT" -eq 0 ]; then
    echo "âŒ Error: No valid packages found in $GAME_LIST_FILE"
    exit 1
fi

echo "âœ… Monitoring $APP_COUNT app(s):"
while IFS= read -r app || [ -n "$app" ]; do
    [ -z "$app" ] && continue
    echo "   â€¢ $app"
    init_app_tracking "$app"
done < /tmp/mon_apps_list.txt
echo ""

# Per-app tracking variables (using temp files for simplicity)
init_app_tracking() {
    local pkg="$1"
    echo "0" > "/tmp/mon_${pkg}_watts"
    echo "0" > "/tmp/mon_${pkg}_temp"    echo "0" > "/tmp/mon_${pkg}_fps"
    echo "0" > "/tmp/mon_${pkg}_count"
    echo "0" > "/tmp/mon_${pkg}_lastfps"
}

get_app_stat() {
    local pkg="$1"
    local field="$2"
    cat "/tmp/mon_${pkg}_${field}" 2>/dev/null || echo "0"
}

set_app_stat() {
    local pkg="$1"
    local field="$2"
    local value="$3"
    echo "$value" > "/tmp/mon_${pkg}_${field}"
}

# Initialize tracking for all monitored apps
echo "$MONITORED_APPS" | while read app; do
    [ -n "$app" ] && init_app_tracking "$app"
done

# Trap for cleanup
cleanup() {
    echo ""
    echo "ðŸ›‘ Monitor stopped. Saving final stats..."
    echo "$MONITORED_APPS" | while read pkg; do
        [ -n "$pkg" ] || continue
        count=$(get_app_stat "$pkg" "count")
        if [ "$count" -gt 0 ]; then
            save_stats "$pkg" \
                "$(get_app_stat "$pkg" "watts")" \
                "$(get_app_stat "$pkg" "temp")" \
                "$(get_app_stat "$pkg" "fps")" \
                "$count"
        fi
        # Clean temp files
        rm -f "/tmp/mon_${pkg}_"* 2>/dev/null
    done
    exit 0
}
trap cleanup TERM INT

# Main monitoring loop
while true; do
    CURRENT_PKG=$(get_current_pkg)
    
    # Check if current app is in our monitored list
    if [ -n "$CURRENT_PKG" ] && is_monitored_app "$CURRENT_PKG"; then
        # âœ… App is monitored - collect stats
        
        # 1. Temp & Power
        RAW_TEMP=$(cat "$TEMP_FILE" 2>/dev/null || echo "0")
        TEMP_VAL=$((RAW_TEMP / 10))
        
        VOLT=$(cat "$VOLT_FILE" 2>/dev/null | tr -d '[:space:]')
        CURR=$(cat "$CURR_FILE" 2>/dev/null | tr -d '[:space:]')
        WATT_NUM="0.00"
        if [ -n "$VOLT" ] && [ -n "$CURR" ]; then
            WATT_NUM=$(awk -v v="$VOLT" -v c="$CURR" 'BEGIN{
                volts=v/1000000; amps=c/1000000
                if(amps<0)amps=-amps
                val=volts*amps
                if(val>=0.01&&val<=60)printf "%.2f",val; else print "0.00"
            }')
        fi

        # 2. ðŸš€ GET REAL FPS
        ACTUAL_FPS=$(get_real_fps "$CURRENT_PKG")
        [ -z "$ACTUAL_FPS" ] && ACTUAL_FPS=0

        # 3. CPU Load
        CPU_LOAD=$(get_cpu_load)

        # Get current totals for this app
        TOTAL_W=$(get_app_stat "$CURRENT_PKG" "watts")
        TOTAL_T=$(get_app_stat "$CURRENT_PKG" "temp")
        TOTAL_F=$(get_app_stat "$CURRENT_PKG" "fps")
        COUNT=$(get_app_stat "$CURRENT_PKG" "count")

        # Accumulate
        TOTAL_W=$(awk -v t="$TOTAL_W" -v w="$WATT_NUM" 'BEGIN{print t+w}')
        TOTAL_T=$((TOTAL_T + TEMP_VAL))
        TOTAL_F=$((TOTAL_F + ACTUAL_FPS))
        COUNT=$((COUNT + 1))

        # Save updated totals
        set_app_stat "$CURRENT_PKG" "watts" "$TOTAL_W"
        set_app_stat "$CURRENT_PKG" "temp" "$TOTAL_T"
        set_app_stat "$CURRENT_PKG" "fps" "$TOTAL_F"
        set_app_stat "$CURRENT_PKG" "count" "$COUNT"
        set_app_stat "$CURRENT_PKG" "lastfps" "$ACTUAL_FPS"

        # Calculate running average FPS
        AVG_F=$(awk -v t="$TOTAL_F" -v c="$COUNT" 'BEGIN{printf "%.0f",t/c}')

        # Display
        printf "\rðŸŽ® [%s] FPS:%3d (Avg:%3d) | CPU:%3d%% | Pwr:%sW  " \
            "$CURRENT_PKG" "$ACTUAL_FPS" "$AVG_F" "$CPU_LOAD" "$WATT_NUM"
            
        # Save stats every 10 samples
        if [ $((COUNT % 10)) -eq 0 ]; then
            save_stats "$CURRENT_PKG" "$TOTAL_W" "$TOTAL_T" "$TOTAL_F" "$COUNT"
        fi
                
    else
        # âŒ App not monitored - idle
        printf "\râ³ Waiting for monitored app... "
        sleep 2
        continue
    fi
    notify_engine "ðŸ“Š $CURRENT_PKG" "FPS: $ACTUAL_FPS | CPU:$CPU_LOAD%"
    sleep 2
done