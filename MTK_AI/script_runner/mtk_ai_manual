#!/system/bin/sh
# MTK AI ENGINE - Manual Overrides (Fixed Version)
# Place in: /data/adb/service.d/mtk_ai_manual
# chmod 755 /data/adb/service.d/mtk_ai_manual

CONFIG_DIR="/sdcard/MTK_AI_Engine"
CONFIG_FILE="$CONFIG_DIR/devfreq_config.conf"
LOG_FILE="$CONFIG_DIR/MTK_AI_Engine.log"
PPM_CONFIG="$CONFIG_DIR/ppm_config.conf"
PPM_PATH="/proc/ppm/policy_status"

log_msg() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

echo "=== MTK AI MANUAL OVERRIDES STARTING ==="

# --- 1. RESOLUTION SCALING ---
if [ -f "$CONFIG_DIR/manual_scaling.txt" ]; then
    PERCENT=$(cat "$CONFIG_DIR/manual_scaling.txt" 2>/dev/null | tr -d '\r\n\t ')
    if [ -n "$PERCENT" ] && [ "$PERCENT" -ge 50 ] 2>/dev/null && [ "$PERCENT" -le 200 ] 2>/dev/null; then
        # Get current density properly
        CURRENT_DENSITY=$(dumpsys display 2>/dev/null | grep "mBaseDisplayInfo" | head -n1 | awk '{print $6}' | cut -d',' -f1)
        if [ -z "$CURRENT_DENSITY" ] || ! [ "$CURRENT_DENSITY" -gt 0 ] 2>/dev/null; then
            CURRENT_DENSITY=480  # Fallback
        fi
        
        NEW_DENSITY=$((CURRENT_DENSITY * PERCENT / 100))
        echo "Applying scaling: ${PERCENT}% ‚Üí ${NEW_DENSITY} DPI"
        
        # Apply with proper context
        su -c "wm density $NEW_DENSITY" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "‚úì Scaling applied successfully"
        else
            echo "‚úó Failed to apply scaling"
        fi
    else
        echo "Invalid scaling value: '$PERCENT'"
    fi
else
    echo "No scaling config found"
fi

# --- 2. CPU GOVERNOR ---
if [ -f "$CONFIG_DIR/manual_governor.txt" ]; then
    GOVERNOR=$(cat "$CONFIG_DIR/manual_governor.txt" 2>/dev/null | tr -d '\r\n\t ')
    if [ -n "$GOVERNOR" ]; then
        echo "Applying governor: $GOVERNOR"
        for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
            if [ -f "$cpu/cpufreq/scaling_available_governors" ]; then
                if grep -q "$GOVERNOR" "$cpu/cpufreq/scaling_available_governors"; then
                    su -c "echo '$GOVERNOR' > '$cpu/cpufreq/scaling_governor'" 2>/dev/null
                    if [ $? -eq 0 ]; then
                        echo "‚úì Governor applied to $cpu"
                    else
                        echo "‚úó Failed to apply governor to $cpu"
                    fi
                else
                    echo "Governor '$GOVERNOR' not available for $cpu"
                fi
            fi
        done
    else
        echo "Empty governor config"
    fi
else
    echo "No governor config found"
fi

# --- 3. RENDERER ---
if [ -f "$CONFIG_DIR/manual_renderer.txt" ]; then
    RENDERER=$(cat "$CONFIG_DIR/manual_renderer.txt" 2>/dev/null | tr -d '\r\n\t ')
    if [ -n "$RENDERER" ]; then
        echo "Applying renderer: $RENDERER"
        su -c "setprop debug.hwui.renderer '$RENDERER'" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "‚úì Renderer applied"
        else
            echo "‚úó Failed to apply renderer"
        fi
    else
        echo "Empty renderer config"
    fi
else
    echo "No renderer config found"
fi

# --- 4. REFRESH RATE ---
if [ -f "$CONFIG_DIR/manual_refresh_lock.txt" ]; then
    MODE_ID=$(cat "$CONFIG_DIR/manual_refresh_lock.txt" 2>/dev/null | tr -d '\r\n\t ')
    if [ -n "$MODE_ID" ]; then
        echo "Applying refresh rate mode: $MODE_ID"
        su -c "service call SurfaceFlinger 1035 i32 $MODE_ID" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "‚úì Refresh rate applied"
        else
            echo "‚úó Failed to apply refresh rate"
        fi
    else
        echo "Empty refresh rate config"
    fi
else
    echo "No refresh rate config found"
fi

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Config file not found"
    exit 1
fi

echo "Loading devfreq settings..."

# Process each line
while IFS= read -r line; do
    # Skip comments and empty lines
    case "$line" in
        \#*|"") continue ;;
    esac
    
    # Extract device and governor from "device"="governor" format
    if echo "$line" | grep -q '=".*"$'; then
        # Remove quotes and split
        clean_line=$(echo "$line" | sed 's/"//g')
        DEVICE=$(echo "$clean_line" | cut -d'=' -f1)
        GOVERNOR=$(echo "$clean_line" | cut -d'=' -f2)
        
        if [ -n "$DEVICE" ] && [ -n "$GOVERNOR" ]; then
            GOV_PATH="/sys/class/devfreq/$DEVICE/governor"
            if [ -f "$GOV_PATH" ]; then
                echo "$GOVERNOR" > "$GOV_PATH" 2>/dev/null
                if [ $? -eq 0 ]; then
                    echo "‚úÖ Applied $GOVERNOR to $DEVICE"
                else
                    echo "‚ùå Failed to apply $GOVERNOR to $DEVICE"
                fi
            else
                echo "‚ö†Ô∏è Device not found: $DEVICE"
            fi
        fi
    fi
done < "$CONFIG_FILE"

# Check if PPM interface exists
if [ ! -f "$PPM_PATH" ]; then
    log_msg "‚ö†Ô∏è PPM not available on this device"
    exit 0
fi

# Check if config file exists
if [ ! -f "$PPM_CONFIG" ]; then
    log_msg "‚ÑπÔ∏è No PPM config found, using defaults"
    exit 0
fi

log_msg "üéÆ Loading PPM policies from SDCard..."

# Source the config file to get policy variables
. "$PPM_CONFIG" 2>/dev/null

# Apply all PPM policies (0-9)
for i in 0 1 2 3 4 5 6 7 8 9; do
    # Get policy state using eval
    eval "POLICY_STATE=\$policies[$i]"
    
    if [ "$POLICY_STATE" = "0" ] || [ "$POLICY_STATE" = "1" ]; then
        echo "$i $POLICY_STATE" > "$PPM_PATH" 2>/dev/null
        if [ $? -eq 0 ]; then
            log_msg "‚úÖ Applied PPM policy $i = $POLICY_STATE"
        else
            log_msg "‚ùå Failed to apply PPM policy $i"
        fi
    else
        log_msg "‚ö†Ô∏è Policy $i not set in config, skipping"
    fi
done

log_msg "‚úÖ PPM policies loaded successfully from SDCard!"

echo "‚úÖ Devfreq settings loaded successfully!"

settings put global low_power 0
settings put global low_power_sticky 0
echo "0" > /proc/sys/kernel/panic

echo "=== MTK AI MANUAL OVERRIDES COMPLETED ==="
