#!/system/bin/sh

MOD_DIR="/data/adb/modules/MTK_AI"

# Organized SurfaceFlinger + VSync Optimizer
sh $PERF_DISP_PATH
# ==================================================
# HARDENED SURFACEFLINGER CONTROLLER (MTK SAFE)
# ==================================================

# -------- PATHS --------
SF_LOCK="/dev/.sf_last_call"
SF_TX_CACHE="/dev/.sf_tx"
SF_FAIL="/dev/.sf_fail"
SF_DISABLED="/dev/.sf_disabled"

# -------- TUNABLES --------
SF_MIN_INTERVAL=2     # seconds between calls
SF_FAIL_MAX=3         # auto-disable after this many failures
SF_TIMEOUT="1s"       # service call timeout

# ==================================================
# CHECK IF SURFACEFLINGER EXISTS
# ==================================================
sf_alive() {
  service list 2>/dev/null | grep -q "SurfaceFlinger"
}

# ==================================================
# RATE LIMITER
# ==================================================
sf_can_call() {
  local now last
  now=$(date +%s)
  last=$(cat "$SF_LOCK" 2>/dev/null || echo 0)

  [ $((now - last)) -ge "$SF_MIN_INTERVAL" ] || return 1
  echo "$now" > "$SF_LOCK"
  return 0
}

# ==================================================
# TRANSACTION ID DETECTION (CACHE ONCE)
# ==================================================
sf_detect_tx() {
  [ -f "$SF_TX_CACHE" ] && return 0

  for tx in 1022 1035 1008; do
    service call SurfaceFlinger "$tx" i32 0 \
      >/dev/null 2>&1 && {
        echo "$tx" > "$SF_TX_CACHE"
        return 0
      }
  done

  return 1
}

# ==================================================
# FAILURE GUARD
# ==================================================
sf_fail_guard() {
  local f
  f=$(cat "$SF_FAIL" 2>/dev/null || echo 0)
  f=$((f + 1))
  echo "$f" > "$SF_FAIL"

  if [ "$f" -ge "$SF_FAIL_MAX" ]; then
    touch "$SF_DISABLED"
    return 1
  fi
  return 0
}

# ==================================================
# MAIN SAFE SURFACEFLINGER CALL
# ==================================================
sf_call() {
  # permanently disabled
  [ -f "$SF_DISABLED" ] && return 1

  sf_alive || return 1
  sf_can_call || return 1
  sf_detect_tx || return 1

  local tx
  tx=$(cat "$SF_TX_CACHE")

  timeout "$SF_TIMEOUT" \
    service call SurfaceFlinger "$tx" "$@" \
    >/dev/null 2>&1 && return 0

  sf_fail_guard
  return 1
}

# ==================================================
# PUBLIC HELPERS (USE THESE)
# ==================================================

# Enable render / fps hint
sf_enable() {
  sf_call i32 1
}

# Disable render / fps hint
sf_disable() {
  sf_call i32 0
}

# Reset all SF state (for debugging / reboot cleanup)
sf_reset() {
  rm -f "$SF_LOCK" "$SF_TX_CACHE" "$SF_FAIL" "$SF_DISABLED"
}

# ==================================================
# END
# ==================================================
