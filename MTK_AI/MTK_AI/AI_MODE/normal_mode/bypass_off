#!/system/bin/sh
# MTK_AI Engine – BYPASS OFF (Restore Normal Charging)

BASE_DIR="/sdcard/MTK_AI_Engine"
LOG_FILE="$BASE_DIR/MTK_AI_Engine.log"
ICON_PATH="/data/adb/modules/MTK_AI/icon.png"
NOTIFY_ENABLED_FILE="$BASE_DIR/enable_notifications"

mkdir -p "$BASE_DIR"

log_msg() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

notify_status() {
[ ! -f "$NOTIFY_ENABLED_FILE" ] && return 0
    su -lp 2000 -c \
    "cmd notification post -I $ICON_PATH -S bigtext \
     -t 'Bypass Mode' tag 'OFF | Normal charging restored'" \
     >/dev/null 2>&1
}

write_try() {
    node="$1"
    value="$2"
    [ -f "$node" ] || return 1
    echo "$value" > "$node" 2>/dev/null && return 0
    return 1
}

log_msg "Bypass OFF started"

# --------------------------------------------------
# 1️⃣ REAL BYPASS → OFF (0)
# --------------------------------------------------
BYPASS_OFF="
/sys/devices/platform/charger/bypass_charger
/sys/class/power_supply/battery/bypass_charger
/sys/kernel/nubia_charge/charger_bypass
"

for n in $BYPASS_OFF; do
    if write_try "$n" 0; then
        log_msg "Bypass OFF via $n"
        notify_status
        exit 0
    fi
done

# --------------------------------------------------
# 2️⃣ MEDIATEK POWER PATH RESTORE
# --------------------------------------------------
if write_try "/proc/mtk_battery_cmd/en_power_path" 0; then
    log_msg "MTK power path restored"
    notify_status
    exit 0
fi

# --------------------------------------------------
# 3️⃣ ENABLE CHARGING (1)
# --------------------------------------------------
ENABLE_CHARGING_ONE="
/sys/class/oplus_chg/battery/mmi_charging_enable
/sys/class/power_supply/battery/mmi_charging_enable
/sys/devices/virtual/oplus_chg/battery/mmi_charging_enable
/sys/devices/platform/soc/soc:oplus,chg_intf/oplus_chg/battery/mmi_charging_enable
/sys/devices/platform/soc/soc:oplus,chg_intf/oplus_chg/battery/chg_enable
/sys/class/power_supply/battery/charging_enabled
/sys/class/power_supply/battery/charge_enabled
/sys/class/power_supply/battery/battery_charging_enabled
/sys/class/power_supply/ac/charging_enabled
/sys/class/power_supply/dc/charging_enabled
/sys/class/qcom-battery/charging_enabled
/sys/devices/platform/omap/omap_i2c.3/i2c-3/3-005f/charge_enable
/sys/class/power_supply/bq2589x_charger/enable_charging
/sys/devices/virtual/power_supply/manta-battery/charge_enabled
/sys/devices/platform/huawei_charger/enable_charger
/sys/class/hw_power/charger/charge_data/enable_charger
/sys/devices/platform/lge-unified-nodes/charging_enable
"

for n in $ENABLE_CHARGING_ONE; do
    if write_try "$n" 1; then
        log_msg "Charging ENABLED via $n"
        notify_status
        exit 0
    fi
done

# --------------------------------------------------
# 4️⃣ INPUT SUSPEND → OFF (0)
# --------------------------------------------------
INPUT_RESUME_ZERO="
/sys/class/power_supply/battery/input_suspend
/sys/class/power_supply/battery/battery_input_suspend
/sys/class/qcom-battery/input_suspend
/sys/kernel/debug/google_charger/input_suspend
"

for n in $INPUT_RESUME_ZERO; do
    if write_try "$n" 0; then
        log_msg "Input resumed via $n"
        notify_status
        exit 0
    fi
done

# --------------------------------------------------
# 5️⃣ DISABLE FLAGS → OFF (0)
# --------------------------------------------------
DISABLE_OFF_ZERO="
/proc/smb1357_disable_chrg
/proc/driver/charger_limit_enable
/sys/devices/platform/charger/tran_aichg_disable_charger
/sys/class/power_supply/battery/charge_disable
/sys/class/power_supply/battery/op_disable_charge
/sys/class/power_supply/chargalg/disable_charging
/sys/class/power_supply/battery/connect_disable
/sys/class/power_supply/battery/stop_charge
/sys/devices/platform/soc/soc:qcom,pmic_glink/soc:qcom,pmic_glink:qcom,battery_charger/force_charger_suspend
/sys/class/power_supply/battery_ext/smart_charging_interruption
/sys/class/qcom-battery/batt_protect_en
/sys/class/asuslib/charging_suspend_en
/sys/class/asuslib/charger_limit_en
/sys/class/power_supply/battery/store_mode
/sys/class/power_supply/battery/test_mode
/sys/class/power_supply/battery/batt_slate_mode
/sys/class/power_supply/battery/restricted_charging
/sys/class/power_supply/wireless/restricted_charging
/sys/module/qpnp_adaptive_charge/parameters/blocking
"

for n in $DISABLE_OFF_ZERO; do
    if write_try "$n" 0; then
        log_msg "Disable flag cleared via $n"
        notify_status
        exit 0
    fi
done

# --------------------------------------------------
# 6️⃣ HARD CHARGER DISABLE → OFF (0)
# --------------------------------------------------
HARD_DISABLE_OFF="
/sys/devices/platform/mt-battery/disable_charger
/sys/module/pmic8058_charger/parameters/disabled
/sys/module/pm8921_charger/parameters/disabled
/sys/module/smb137b/parameters/disabled
"

for n in $HARD_DISABLE_OFF; do
    if write_try "$n" 0; then
        log_msg "Hard charger re-enabled via $n"
        notify_status
        exit 0
    fi
done

# --------------------------------------------------
# ❌ FAILURE
# --------------------------------------------------
log_msg "No bypass-related node restored (already normal?)"
notify_status
exit 1
