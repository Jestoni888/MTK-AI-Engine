#!/system/bin/sh
#!/data/adb/modules/MTK_AI/busybox sh

for policy in /sys/devices/system/cpu/cpufreq/policy*; do
    # Set the governor to schedutil
    echo "powersave" | su -c "tee $policy/scaling_governor" 
done
        settings put global low_power 1
settings put global low_power_sticky 1


# â”€â”€â”€ One-Shot Power Saving Mode (Safe & Effective) â”€â”€â”€
# Usage: 
#   state=1 â†’ Enable power saving
#   state=0 â†’ Disable

state=${1:-0}

echo "âš¡ One-Shot Power Saving Mode"
echo "State: $( [ "$state" = "1" ] && echo "ON" || echo "OFF" )"
echo "---"

if [ "$state" = "1" ]; then
    echo "ðŸ”‹ Enabling aggressive power saving..."

    settings put global app_auto_restriction_enabled 1
    settings put global forced_app_standby_enabled 1
    settings put global app_standby_enabled 1
    settings put global forced_app_standby_for_small_battery_enabled 1
fi

    # --- Disable MIUI AI Preload (if exists) ---
    if settings get system ai_preload_user_state | grep -q "^[0-9]"; then
        settings put system ai_preload_user_state 0
        echo "âœ… Disabled MIUI AI preload"
    fi

    # --- Aggressively idle all 3rd-party apps ---
    echo "ðŸ§¹ Forcing all user apps into standby..."
    for pkg in $(pm list packages -3 | cut -f2 -d':'); do
        am set-inactive "$pkg" true 2>/dev/null
        am set-idle "$pkg" true 2>/dev/null
        am make-uid-idle --user current "$pkg" 2>/dev/null
    done

    # Trigger Doze immediately
    dumpsys deviceidle enable 2>/dev/null
    dumpsys deviceidle force-idle 2>/dev/null

    # --- Optional: Stop non-critical vendor services (safe to kill) ---
    # These are debug/perf services that drain battery
    for svc in woodpeckerd atfwd perfd cnss_diag subsystem_ramdump tcpdump; do
        stop "$svc" 2>/dev/null
        killall -9 "$svc" 2>/dev/null
    done

# DEVFREQ STRICT POWERSAVE MODE
# This removes the performance filters and forces all nodes to save energy
for g in /sys/class/devfreq/*/governor; do
    [ -f "$g" ] || continue
    NAME=$(basename "$(dirname "$g")")
    
    # Check supported governors for the current node
    SUP=$(cat "$(dirname "$g")/available_governors" 2>/dev/null)

    # Force powersave if supported, otherwise fallback to simple_ondemand
    if echo "$SUP" | grep -q "powersave"; then
        chmod 644 "$g" 2>/dev/null
        echo powersave | su -c "tee $g"
        log_msg "ðŸ”‹ Powersave mode: $NAME â†’ powersave"
    else
        # If powersave isn't a valid option for this kernel node, 
        # use the most efficient alternative available.
        chmod 644 "$g" 2>/dev/null
        echo simple_ondemand | su -c "tee $g" 2>/dev/null
        log_msg "ðŸ”‹ Powersave mode: $NAME â†’ simple_ondemand (fallback)"
    fi
done

