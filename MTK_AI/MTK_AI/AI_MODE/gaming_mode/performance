#!/system/bin/sh

# Maximum Performance Script ‚Äî Final Version
# Based on your kr-script/mtk XML logic
# Targets: mt6983, mt6895, and gpufreqv2-based Dimensity SoCs

set -e

echo "[+] Applying MAXIMUM PERFORMANCE CONFIG..."

# --- Detect DVFSRC path ---
dvfsrc_a=/sys/devices/platform/soc/1c00f000.dvfsrc
dvfsrc_b=/sys/devices/platform/1c00f000.dvfsrc
dvfsrc_c=/sys/devices/platform/1c013000.dvfsrc
dvfsrc_d=/sys/class/devfreq/mtk-dvfsrc-devfreq
dvfsrc_dir=""
for d in "$dvfsrc_a" "$dvfsrc_b" "$dvfsrc_c" "$dvfsrc_d"; do
  if [ -d "$d" ]; then
    dvfsrc_dir="$d"
    break
  fi
done

if [ -z "$dvfsrc_dir" ]; then
  echo "[!] DVFSRC not found. Skipping DDR tuning."
fi

# --- Paths ---
perfmgr=/sys/module/mtk_fpsgo/parameters/perfmgr_enable
pandora_feas=/sys/module/perfmgr_mtk/parameters/perfmgr_enable
fpsgo=/sys/kernel/fpsgo/common/fpsgo_enable
fbt_ceiling=/sys/kernel/fpsgo/fbt/enable_ceiling
ged_kpi=/sys/module/sspm_v3/holders/ged/parameters/is_GED_KPI_enabled
dcs_mode=/sys/kernel/ged/hal/dcs_mode

# Prefer Pandora FEAS if available
if [ -f "$pandora_feas" ]; then
  perfmgr="$pandora_feas"
fi

# --- Helper: lock_value ---
lock_value() {
  chmod 664 "$2" 2>/dev/null
  echo "$1" > "$2"
  chmod 444 "$2" 2>/dev/null
}

# ==============================
# üîß 1. Enable Performance Subsystems
# ==============================

if [ -f "$fpsgo" ]; then
  echo "[+] Enabling FPSGO..."
  lock_value 1 "$fpsgo"
fi

if [ -f "$fbt_ceiling" ]; then
  echo "[+] Enabling FBT Ceiling..."
  lock_value 1 "$fbt_ceiling"
fi

if [ -f "$perfmgr" ]; then
  echo "[+] Enabling PerfMgr (FEAS)..."
  # Ensure FPSGO is on first
  if [ "$(cat "$fpsgo" 2>/dev/null)" != "1" ]; then
    lock_value 1 "$fpsgo"
  fi
  # GED KPI should be ON unless hybrid governor is used
  if [ ! -d /data/adb/modules/dimensity_hybrid_governor ] && [ -f "$ged_kpi" ]; then
    lock_value 1 "$ged_kpi"
  fi
  lock_value 1 "$perfmgr"
fi

# ==============================
# üéÆ 2. GPU: Lock to MAX Frequency
# ==============================

if [ -f /proc/gpufreqv2/stack_signed_opp_table ]; then
  # Get highest frequency (first line = highest OPP)
  MAX_FREQ=$(head -n1 /proc/gpufreqv2/stack_signed_opp_table | awk '{print $3}' | cut -d',' -f1)
  if [ -n "$MAX_FREQ" ] && [ "$MAX_FREQ" != "0" ]; then
    echo "[+] Locking GPU to max: ${MAX_FREQ}KHz"

    # Set custom upbound (via GED)
    lock_value "$MAX_FREQ" /sys/kernel/ged/hal/custom_upbound_gpu_freq

    # Also disable fixed freq (let upbound control it)
    echo -1 > /proc/gpufreqv2/fix_target_opp_index 2>/dev/null || true
    echo 0 0 > /proc/gpufreqv2/fix_custom_freq_volt 2>/dev/null || true

    # Disable GPT thermal throttle if present
    if [ -f /sys/kernel/thermal/gpt ]; then
      echo disable > /sys/kernel/thermal/gpt
    fi
  fi
fi

# ==============================
# üíæ 3. DDR: Set Min Freq = Max Freq
# ==============================

if [ -n "$dvfsrc_dir" ]; then
  dvfsrc="$dvfsrc_dir/mtk-dvfsrc-devfreq/devfreq/mtk-dvfsrc-devfreq"
  if [ -f "$dvfsrc/max_freq" ] && [ -f "$dvfsrc/min_freq" ]; then
    MAX_DDR=$(cat "$dvfsrc/max_freq")
    if [ -n "$MAX_DDR" ]; then
      echo "[+] Setting DDR min freq to max: $MAX_DDR Hz"
      chmod 664 "$dvfsrc/min_freq" 2>/dev/null
      echo "$MAX_DDR" > "$dvfsrc/min_freq"
      chmod 444 "$dvfsrc/min_freq" 2>/dev/null
    fi
  fi
fi

# ==============================
# üö´ 4. Disable Power-Saving Features
# ==============================

# Disable DCS (Dynamic Core Scaling) ‚Äî keeps all GPU cores active
if [ -f "$dcs_mode" ]; then
  echo "[+] Disabling DCS (keep all GPU cores active)..."
  lock_value 0 "$dcs_mode"
fi

# Disable GED KPI throttling (if not using hybrid governor)
if [ -f "$ged_kpi" ] && [ ! -d /data/adb/modules/dimensity_hybrid_governor ]; then
  echo "[+] Ensuring GED KPI is ENABLED (required for PerfMgr)..."
  lock_value 1 "$ged_kpi"
fi

list_thermal_services() {
	for rc in $(find /system/etc/init /vendor/etc/init /odm/etc/init -type f); do
		grep -r "^service" "$rc" | awk '{print $2}'
	done | grep thermal
}

for svc in $(list_thermal_services); do
	echo "Stopping $svc"
	start "$svc"
	stop "$svc"
done

# ==============================
# ‚úÖ Done
# ==============================

echo ""
echo "‚úÖ MAXIMUM PERFORMANCE ACTIVE!"
echo "   - PerfMgr / FPSGO / FBT: enabled"
echo "   - GPU: locked to max frequency"
echo "   - DDR: min freq = max"
echo "   - DCS: disabled"
echo ""
echo "‚ö†Ô∏è  Monitor temperature! Reboot to restore defaults."
