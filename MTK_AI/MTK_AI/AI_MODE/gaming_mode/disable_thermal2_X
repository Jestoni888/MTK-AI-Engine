#!/system/bin/sh

# --------------------------------------------------------------
# MTK MAX PERFORMANCE SCRIPT — FULL THERMAL & POWER LIMIT DISABLE
# For MediaTek Dimensity/MTxxx devices (Android 10–14)
# Author: Optimized for rooted MTK gaming/performance use
# --------------------------------------------------------------

log() {
    echo "[MTK_MAX_PERF] $1"
}

log "Starting full performance unlock..."

# Ensure we're root
if [ "$(id -u)" != "0" ]; then
    log "❌ Not running as root! Aborting."
    exit 1
fi

# ----------------------------
# 1. Disable Thermal Zones (mode only — skip read-only trip points)
# ----------------------------
for tz in /sys/class/thermal/thermal_zone*; do
    if [ -d "$tz" ] && [ -w "$tz/mode" ]; then
        echo "disabled" > "$tz/mode" 2>/dev/null && log "Disabled thermal zone: $(basename $tz)"
    fi
done

# ----------------------------
# 2. Override MTK kernel thermal driver nodes (if present)
# ----------------------------
for node in \
    /proc/driver/thermal/tzcpu \
    /proc/driver/thermal/tzbattery \
    /proc/driver/thermal/tzcharger \
    /proc/driver/thermal/tzpmic \
    /proc/driver/thermal/tzwmt \
    /proc/driver/thermal/tzbts; do
    if [ -f "$node" ]; then
        echo "1 125000 0 mtktscpu-sysrst 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 200" > "$node" 2>/dev/null
        log "Overrode MTK thermal node: $node"
    fi
done

# ----------------------------
# 3. Lock CPU to MAX frequency (all clusters)
# ----------------------------
for policy in /sys/devices/system/cpu/cpufreq/policy*; do
    if [ -d "$policy" ]; then        MAX=$(cat "$policy/cpuinfo_max_freq")
        echo "performance" > "$policy/scaling_governor" 2>/dev/null
        echo "$MAX" > "$policy/scaling_min_freq" 2>/dev/null
        echo "$MAX" > "$policy/scaling_max_freq" 2>/dev/null
        log "Locked CPU $(basename $policy) to $MAX kHz"
    fi
done

# Disable core control (prevent big.LITTLE hotplug from disabling cores)
for cctl in /sys/devices/system/cpu/cpu*/core_ctl/enable; do
    [ -w "$cctl" ] && echo 0 > "$cctl" && log "Disabled core_ctl for $(dirname $cctl)"
done

# ----------------------------
# 4. Lock GPU to MAX frequency (Mali on MTK)
# ----------------------------
GPU_PATH=""
# Try common MTK Mali paths
for candidate in \
    /sys/class/devfreq/*mali* \
    /sys/class/devfreq/13040000.mali \
    /sys/class/devfreq/13050000.mali \
    /sys/class/devfreq/13060000.mali \
    /sys/class/devfreq/13070000.mali; do
    if [ -d "$candidate" ]; then
        GPU_PATH="$candidate"
        break
    fi
done

if [ -n "$GPU_PATH" ]; then
    MAX_GPU=$(cat "$GPU_PATH/max_freq")
    echo "$MAX_GPU" > "$GPU_PATH/min_freq" 2>/dev/null
    echo "performance" > "$GPU_PATH/governor" 2>/dev/null
    log "GPU locked to $MAX_GPU Hz"
else
    log "⚠️ GPU path not found — skipping GPU lock"
fi

# ----------------------------
# 5. Disable MTK gpufreq power/thermal limits (CRITICAL FOR MTK)
# ----------------------------
GPUCMD="/proc/gpufreq"
if [ -d "$GPUCMD" ]; then
    for flag in \
        ignore_thermal_protect \
        ignore_pbm_limited \
        ignore_batt_oc \
        ignore_batt_percent \
        ignore_low_batt \        disable_ptpod \
        force_gpu_power_mode; do
        [ -w "$GPUCMD/$flag" ] && echo "1" > "$GPUCMD/$flag" && log "Set $flag=1"
    done

    # Some kernels require this to disable dynamic scaling
    [ -w "$GPUCMD/gpufreq_power_limited" ] && echo "0" > "$GPUCMD/gpufreq_power_limited"
    log "MTK gpufreq limits fully disabled"
fi

# ----------------------------
# 6. Disable Power Policy Manager (PPM)
# ----------------------------
PPM="/proc/ppm"
if [ -d "$PPM" ]; then
    # Disable PPM entirely if possible
    [ -w "$PPM/enabled" ] && echo "0" > "$PPM/enabled" && log "PPM disabled"

    # Or disable individual thermal policies
    for idx in $(seq 0 10); do
        [ -w "$PPM/policy_status" ] && echo "$idx 0" > "$PPM/policy_status" 2>/dev/null
    done
    log "PPM thermal policies neutralized"
fi

# ----------------------------
# 7. Block battery temperature input (trick system)
# ----------------------------
BATT_TEMP="/sys/class/power_supply/battery/temp"
if [ -w "$BATT_TEMP" ]; then
    mount -o bind /dev/null "$BATT_TEMP" 2>/dev/null && log "Battery temp feed blocked"
fi

# Also override thermal_input if exists
[ -w /sys/class/power_supply/battery/thermal_input ] && echo "25" > /sys/class/power_supply/battery/thermal_input

# ----------------------------
# 8. Freeze thermal daemons (prevent reactivation)
# ----------------------------
for daemon in thermal thermalloadalgod mtk_thermal thermald vendor.thermal; do
    for pid in $(pgrep -f "$daemon" 2>/dev/null); do
        kill -STOP "$pid" 2>/dev/null && log "Frozen thermal daemon: $daemon (PID $pid)"
    done
done

# ----------------------------
# 9. Optional: Disable vendor thermal HAL (if script runs early in boot)
# ----------------------------
# Uncomment ONLY if you've backed up these files!
# for hal in /vendor/bin/hw/android.hardware.thermal*; do#     [ -f "$hal" ] && mv "$hal" "${hal}.bak" && log "Disabled thermal HAL: $hal"
# done

# ----------------------------
# Final message
# ----------------------------
log "✅ MAX PERFORMANCE MODE ACTIVE"
log "⚠️  NO THERMAL PROTECTION REMAINS. MONITOR DEVICE TEMPERATURE!"
