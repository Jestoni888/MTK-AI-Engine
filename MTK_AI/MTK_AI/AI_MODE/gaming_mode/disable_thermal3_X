#!/system/bin/sh

# ============================================================
# MTK NUCLEAR PERF ‚Äî ABSOLUTE FINAL ANTI-THROTTLING SCRIPT
# Targets: Dimensity 700/800/900/1200/1300, Helio G99, etc.
# Works on Realme, Redmi, Infinix, Tecno, Vivo, Oppo (rooted)
# ============================================================

log() {
    echo "[NUCLEAR_PERF] $*"
}

# --- ROOT CHECK ---
if [ "$(id -u)" != "0" ]; then
    log "‚ùå FATAL: Must run as root!"
    exit 1
fi

log "üöÄ INITIATING NUCLEAR PERFORMANCE MODE..."

# --- 1. DISABLE ALL THERMAL ZONES (MODE ONLY) ---
for tz in /sys/class/thermal/thermal_zone*; do
    [ -w "$tz/mode" ] && echo "disabled" > "$tz/mode" && log "Disabled $tz"
done

# --- 2. DISABLE COOLING DEVICES ---
for dev in /sys/class/thermal/cooling_device*; do
    [ -w "$dev/cur_state" ] && echo "0" > "$dev/cur_state" && log "Cooling off: $dev"
done

# --- 3. OVERRIDE MTK KERNEL THERMAL NODES ---
for node in tzcpu tzbattery tzcharger tzpmic tzwmt tzbts; do
    path="/proc/driver/thermal/$node"
    if [ -f "$path" ]; then
        echo "1 125000 0 mtktscpu-sysrst 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 200" > "$path" 2>/dev/null
        log "Overrode $path"
    fi
done

# --- 4. LOCK ALL CPU CORES ONLINE + MAX FREQ ---
for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
    if [ -f "$cpu/online" ]; then
        echo 1 > "$cpu/online" 2>/dev/null
    fi
    if [ -d "$cpu/cpufreq" ]; then
        MAX=$(cat "$cpu/cpufreq/cpuinfo_max_freq")
        echo "performance" > "$cpu/cpufreq/scaling_governor" 2>/dev/null
        echo "$MAX" > "$cpu/cpufreq/scaling_min_freq" 2>/dev/null
        echo "$MAX" > "$cpu/cpufreq/scaling_max_freq" 2>/dev/null
    fi
   done
log "All CPU cores locked to max frequency"

# --- 5. LOCK GPU TO MAX (Mali on MTK) ---
GPU=""
for cand in /sys/class/devfreq/*mali* /sys/class/devfreq/130[4-7]0000.mali; do
    [ -d "$cand" ] && GPU="$cand" && break
done

if [ -n "$GPU" ]; then
    MAX_GPU=$(cat "$GPU/max_freq")
    echo "$MAX_GPU" > "$GPU/min_freq" 2>/dev/null
    echo "performance" > "$GPU/governor" 2>/dev/null
    log "GPU locked to $MAX_GPU Hz"
else
    log "‚ö†Ô∏è GPU not found ‚Äî skipping"
fi

# --- 6. DISABLE MTK GPU POWER LIMITS (CRITICAL) ---
GPUCMD="/proc/gpufreq"
if [ -d "$GPUCMD" ]; then
    for flag in ignore_thermal_protect ignore_pbm_limited ignore_batt_oc ignore_batt_percent ignore_low_batt disable_ptpod force_gpu_power_mode; do
        [ -w "$GPUCMD/$flag" ] && echo "1" > "$GPUCMD/$flag" && log "GPU: $flag=1"
    done
    [ -w "$GPUCMD/gpufreq_power_limited" ] && echo "0" > "$GPUCMD/gpufreq_power_limited"
fi

# --- 7. DISABLE PPM (POWER POLICY MANAGER) ---
PPM="/proc/ppm"
if [ -d "$PPM" ]; then
    [ -w "$PPM/enabled" ] && echo "0" > "$PPM/enabled"
    for i in $(seq 0 20); do
        [ -w "$PPM/policy_status" ] && echo "$i 0" > "$PPM/policy_status" 2>/dev/null
    done
    log "PPM fully disabled"
fi

# --- 8. DISABLE BATTERY SAFETY LIMITS ---
BATT="/sys/class/power_supply/battery"
if [ -d "$BATT" ]; then
    # Max charging current (6A = 6000000 ¬µA)
    [ -w "$BATT/input_current_max" ] && echo "6000000" > "$BATT/input_current_max"
    [ -w "$BATT/constant_charge_current_max" ] && echo "6000000" > "$BATT/constant_charge_current_max"
    [ -w "$BATT/voltage_max" ] && echo "4500000" > "$BATT/voltage_max"  # 4.5V
    # Fake cool battery
    [ -w "$BATT/temp" ] && mount -o bind /dev/null "$BATT/temp" 2>/dev/null
    [ -w "$BATT/thermal_input" ] && echo "25" > "$BATT/thermal_input"
    log "Battery limits maxed out"
fi
# --- 9. KILL & FREEZE THERMAL DAEMONS ---
for name in thermal thermalloadalgod mtk_thermal thermald batt_healthd charger_monitor vendor.thermal; do
    for pid in $(pgrep -f "$name" 2>/dev/null); do
        kill -STOP "$pid" 2>/dev/null && log "Frozen: $name (PID $pid)"
    done
done

# --- 10. DISABLE VENDOR THERMAL HAL (IF SAFE) ---
HAL_BIN="/vendor/bin/hw/android.hardware.thermal"
if [ -f "${HAL_BIN}@2.0-service" ]; then
    stop vendor.thermal-hal-2-0 2>/dev/null
    mv "${HAL_BIN}@2.0-service" "${HAL_BIN}@2.0-service.nuke" 2>/dev/null && log "Thermal HAL disabled"
elif [ -f "${HAL_BIN}@1.0-service" ]; then
    stop vendor.thermal-hal-1-0 2>/dev/null
    mv "${HAL_BIN}@1.0-service" "${HAL_BIN}@1.0-service.nuke" 2>/dev/null && log "Thermal HAL (v1) disabled"
fi

# --- 11. DISABLE PBM (POWER BUDGET MANAGER) IF PRESENT ---
if [ -d /proc/pbm ]; then
    echo "0" > /proc/pbm/enabled 2>/dev/null && log "PBM disabled"
fi

# --- FINAL MESSAGE ---
log "üí• NUCLEAR PERFORMANCE MODE ACTIVATED"
log "üî• ALL SOFTWARE THERMAL/POWER LIMITS REMOVED"
log "‚ö†Ô∏è HARDWARE MAY OVERHEAT. MONITOR TEMPERATURE!"
log "‚úÖ READY FOR MAXIMUM GAMING/RENDERING LOAD"
