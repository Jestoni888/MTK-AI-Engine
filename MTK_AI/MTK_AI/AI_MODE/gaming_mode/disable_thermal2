#!/system/bin/sh

# Maximum Performance Script (NUCLEAR MODE)
# Uses YOUR provided functions exactly as defined
# FOR BENCHMARKING ONLY ‚Äî NOT FOR DAILY USE

# Source: your mtk_utils.sh functions (inlined below)

lock_value () {
  chmod 644 $2
  echo $1 > $2
  chmod 444 $2
}

sched_boost_set() {
  if [[ "$state" == "no boost" ]]; then
    echo 0 > /sys/devices/system/cpu/sched/sched_boost
  elif [[ "$state" == "all boost" ]]; then
    echo 1 > /sys/devices/system/cpu/sched/sched_boost
  elif [[ "$state" == "foreground boost" ]]; then
    echo 2 > /sys/devices/system/cpu/sched/sched_boost
  fi
}

eas_set() {
  chmod 664 /sys/devices/system/cpu/eas/enable
  if [[ "$state" == "HMP" ]]; then
    echo 0 > /sys/devices/system/cpu/eas/enable
  elif [[ "$state" == "EAS" ]]; then
    echo 1 > /sys/devices/system/cpu/eas/enable
  elif [[ "$state" == "hybrid" ]]; then
    echo 2 > /sys/devices/system/cpu/eas/enable
  fi
  chmod 444 /sys/devices/system/cpu/eas/enable
}

gpu_freq() {
  dvfs=/proc/mali/dvfs_enable
  if [[ "$state" == "0" ]]; then
    echo 0 > /proc/gpufreq/gpufreq_opp_freq
    echo -1 > /proc/gpufreq/gpufreq_opp_freq
    echo 0 0 > /proc/gpufreq/gpufreq_fixed_freq_volt
    echo 1 > $dvfs
  else
    echo 0 > $dvfs
    if [[ "$voltage" == "" || "$voltage" = "-1" ]]; then
      freq_row=$(grep "$state," /proc/gpufreq/gpufreq_opp_dump)
      opp=${freq_row:1:2}
      echo 0 0 > /proc/gpufreq/gpufreq_fixed_freq_volt
      echo $state > /proc/gpufreq/gpufreq_opp_freq
    else
      echo 0 > /proc/gpufreq/gpufreq_opp_freq
      echo $state $voltage > /proc/gpufreq/gpufreq_fixed_freq_volt
    fi
  fi
}

ddr_freq () {
  local boost=/sys/devices/platform/boot_dramboost/dramboost/dramboost
  if [[ -f $boost ]] && [[ "$state" == "1" ]]; then
    echo 0 > $boost
  fi
  echo $state > /sys/devices/platform/10012000.dvfsrc/helio-dvfsrc/dvfsrc_force_vcore_dvfs_opp
}

lock_val() {
  chmod 664 $2 2>/dev/null
  echo $1 > $2
  chmod 000 $2 2>/dev/null
}
ulock_val(){
  chmod 664 $2 2>/dev/null
  echo $1 > $2
}

sspm_thermal_throttle(){
  if [[ "$state" == "1" ]]; then
    echo 'Modify PPM Status‚Ä¶'
    cat /proc/ppm/policy_status | grep -E 'PWR_THRO|THERMAL' | while read row
    do
      idx=$(echo ${row:1:1})
      echo  > /proc/ppm/policy_status
      ulock_val "$idx 0" /proc/ppm/policy_status
    done
  fi
  echo $state > /proc/driver/thermal/sspm_thermal_throttle
}

ultra_limit_set() {
  if [[ "$state" == "1" ]]; then
    echo 'DISABLING THERMAL SAFETY ‚Äî EXTREME RISK!' 1>&2
    echo 'Device may overheat, catch fire, or brick!' 1>&2
    echo 'Ensure active cooling is applied NOW.' 1>&2
    echo 'Proceeding in 5 seconds...' 1>&2
    sleep 5
    echo 'üî• DISABLING THERMAL LIMITS üî•' 1>&2
    t_limit="125"
    no_cooler="0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler 0 0 no-cooler"
    lock_val "1 ${t_limit}000 0 mtktscpu-sysrst $no_cooler 200" /proc/driver/thermal/tzcpu
    lock_val "1 ${t_limit}000 0 mtktspmic-sysrst $no_cooler 1000" /proc/driver/thermal/tzpmic
    lock_val "1 ${t_limit}000 0 mtktsbattery-sysrst $no_cooler 1000" /proc/driver/thermal/tzbattery
    lock_val "1 ${t_limit}000 0 mtk-cl-kshutdown00 $no_cooler 2000" /proc/driver/thermal/tzpa
    lock_val "1 ${t_limit}000 0 mtktscharger-sysrst $no_cooler 2000" /proc/driver/thermal/tzcharger
    lock_val "1 ${t_limit}000 0 mtktswmt-sysrst $no_cooler 1000" /proc/driver/thermal/tzwmt
    lock_val "1 ${t_limit}000 0 mtktsAP-sysrst $no_cooler 1000" /proc/driver/thermal/tzbts
    lock_val "1 ${t_limit}000 0 mtk-cl-kshutdown01 $no_cooler 1000" /proc/driver/thermal/tzbtsnrpa
    lock_val "1 ${t_limit}000 0 mtk-cl-kshutdown02 $no_cooler 1000" /proc/driver/thermal/tzbtspa
    sspm_thermal_throttle
  else
    # Restore defaults (not used here)
    :
  fi
  echo $state > /proc/driver/thermal/sspm_thermal_throttle
}

# ==============================
# üö® START MAX PERFORMANCE SETUP
# ==============================

echo "[+] Applying NUCLEAR MAX PERFORMANCE CONFIG..."

# 1. DISABLE THERMAL LIMITS (120¬∞C ‚Üí 145¬∞C, no coolers)
state=1
ultra_limit_set

# 2. FULL SCHEDULER BOOST
state="all boost"
sched_boost_set

# 3. SWITCH TO HMP (MAX AGGRESSION)
state="HMP"
eas_set

# 4. LOCK GPU TO ABSOLUTE MAX
if [ -f /proc/gpufreq/gpufreq_opp_dump ]; then
  MAX_FREQ=$(head -n1 /proc/gpufreq/gpufreq_opp_dump | awk '{print $4}' | cut -d',' -f1)
  if [ -n "$MAX_FREQ" ] && [ "$MAX_FREQ" != "0" ]; then
    state="$MAX_FREQ"
    voltage="-1"  # Don't fix voltage (use stock)
    gpu_freq
    # Also set GPU upbound limit
    gpu_opp=$(grep "freq = $MAX_FREQ," /proc/gpufreq/gpufreq_opp_dump)
    opp_index=$(( ${gpu_opp:1:2} + 0 ))
    lock_value "$opp_index" /sys/kernel/ged/hal/custom_upbound_gpu_freq
    echo "[+] GPU locked to: ${MAX_FREQ}KHz"
  fi
fi

# 5. LOCK DDR TO MAX OPP
if [ -f /sys/devices/platform/10012000.dvfsrc/helio-dvfsrc/dvfsrc_opp_table ]; then
  OPP_COUNT=$(wc -l < /sys/devices/platform/10012000.dvfsrc/helio-dvfsrc/dvfsrc_opp_table)
  MAX_OPP=$((OPP_COUNT - 1))
  state="$MAX_OPP"
  ddr_freq
  echo "[+] DDR locked to OPP: $MAX_OPP"
fi

# 6. DISABLE MALI DVFS (if exists)
if [ -f /proc/mali/dvfs_enable ]; then
  echo 0 > /proc/mali/dvfs_enable
  echo "[+] Mali DVFS disabled"
fi

echo ""
echo "‚úÖ MAXIMUM PERFORMANCE ACTIVE!"
echo "   - Thermal shutdown disabled (145¬∞C)"
echo "   - CPU: HMP + full boost"
echo "   - GPU: locked to max frequency"
echo "   - DDR: locked to max speed"
echo ""
echo "‚ö†Ô∏è  MONITOR TEMPERATURES! REBOOT TO RESTORE SAFETY."